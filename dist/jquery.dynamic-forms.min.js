/*! Dynamic forms - v0.0.2 - 2014-11-10
* https://github.com/CERNDocumentServer/dynamic-forms
* Copyright (c) 2014 CERN; Licensed Revised, BSD */
!function(a){function b(b,e){this.element=b,this.$el=a(b),this.options=a.extend({},d,e),this._defaults=d,this._name=c,this.init()}var c="dynamicForms",d={messages:{description:"",error:"Error",success:"Success",loading:"Loading ..."},callbacks:{success:function(){},error:function(){},rendered:function(){},loaded:function(){}},templates:{wrapper:"<div class='"+c+"-wrapper'>{{{messages}}} {{{loading}}} {{{content}}}</div>",messages:"<div class='"+c+"-messages'></div>",loading:"<div class='"+c+"-loading'></div>",input:"<label for='{{name}}'>{{label}}</label><input type='text' name='{{name}}' value='{{value}}' placeholder='{{placeholder}}' />",textarea:"<label for='{{name}}'>{{label}}</label><textarea name='{{name}}'></textarea>",select:"<label for='{{name}}'>{{label}}</label><select name='{{name}}'>{{#each values}}<option name='{{value}}'>{{option}}</option>{{/each}}</select>",form:"<form class='"+c+"-form'>{{{content}}} <button class='"+c+"-form-submit' type='submit'>{{label}}</button></form>",description:"<div class='"+c+"-description'>{{{description}}}</div>",error:"<p class='"+c+"-message-error'>{{{message}}}</p>",success:"<p class='"+c+"-message-success'>{{{message}}}</p>"},classes:{description:"."+c+"-description",form:"."+c+"-form",button:"."+c+"-form-submit",messages:"."+c+"-messages",loading:"."+c+"-loading"}};b.prototype={$messages:null,$loading:null,$form:null,$button:null,in_process:!1,init:function(){this._render()},destroy:function(){this.$el.removeData()},loading:function(){this.$loading.html(this.options.messages.loading)},unloading:function(){this.$loading.empty()},message:function(a){this.$messages.html(a)},unmessage:function(){this.$messages.empty()},always:function(){this.unloading()},success:function(a,b){var c=Handlebars.compile(this.options.templates.success);this.message(c({message:this.options.messages.success})),this.options.callbacks.success.call(this,this.$el,a,b,this._render)},error:function(a,b,c){var d=Handlebars.compile(this.options.templates.error);this.message(d({message:this.options.messages.error})),this.options.callbacks.error.call(this,this.$el,a,b,c,this._render)},_save:function(b){var c=a.Deferred();return a.ajax({url:this.options.url,data:b}).done(function(a){c.resolve(a)}).fail(function(a,b,d){c.reject(a,b,d)}),c.promise()},_process:function(){var b=this;b.in_progress=!0,b.unmessage();var c=b.$form.serialize();b.loading(),a.when(b._save(c)).then(function(a){b.success(c,a)},function(a,c,d){b.error(a,c,d)}).always(function(){b.unloading(),b.in_process=!1,b.options.callbacks.loaded.call(b,b.$el)})},_render:function(){var b,c=this,d="",e=Handlebars.compile(c.options.templates.wrapper),f=Handlebars.compile(c.options.templates.messages),g=Handlebars.compile(c.options.templates.loading),h=Handlebars.compile(c.options.templates.form),i=Handlebars.compile(c.options.templates.description);a.when(a.each(c.options.data.content,function(a,e){b=Handlebars.compile(c.options.templates[e.type]),d+=b(e)})).done(function(){var b=h({content:d,label:"Save"}),j=i({description:c.options.data.description}),k=e({description:j,content:b,messages:f(),loading:g()});c.$el.html(a(k).html()),c.options.callbacks.rendered.call(this,this.$el),c._binds()})},_binds:function(){var a=this;a.$messages=a.$el.find(a.options.classes.messages),a.$loading=a.$el.find(a.options.classes.loading),a.$form=a.$el.find(a.options.classes.form),a.$button=a.$el.find(a.options.classes.button),a.$button.on("click",function(b){b.preventDefault(),a.in_process||a._process()})}},a.fn[c]=function(d){return this.each(function(){a.data(this,"plugin_"+c)||a.data(this,"plugin_"+c,new b(this,d))})}}(jQuery,window,document);